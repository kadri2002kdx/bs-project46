<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الملف الشخصي | EcoPlant DZ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --success: #4caf50;
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --primary-light: #4caf50;
            --secondary: #8bc34a;
            --accent: #ffc107;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
            padding: 15px 0;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }
        
        .logo i {
            font-size: 1.5em;
            color: var(--accent);
        }
        
        .nav-links {
            display: flex;
            gap: 28px;
        }
        
        .nav-links a {
            font-weight: 600;
            position: relative;
            padding: 8px 0;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 3px;
            transition: var(--transition);
        }
        
        .nav-links a:hover::after,
        .nav-links a.active::after {
            width: 100%;
        }
        
        .nav-links a:hover,
        .nav-links a.active {
            color: var(--primary);
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .notification-icon, .messages-icon {
            position: relative;
            color: var(--dark);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .notification-icon:hover, .messages-icon:hover {
            color: var(--primary);
        }
        
        .badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 10px 0;
            min-width: 200px;
            display: none;
            z-index: 1000;
        }
        
        .dropdown-menu.show {
            display: block;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .dropdown-item:hover {
            background: #f8f9fa;
            color: var(--primary);
        }
        
        .profile-container {
            max-width: 1200px;
            margin: 100px auto 30px;
            padding: 20px;
        }
        
        .profile-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            text-align: center;
        }
        
        .profile-header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .profile-header p {
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .banner-icon {
            position: absolute;
            top: -20px;
            left: -20px;
            font-size: 8rem;
            opacity: 0.1;
            transform: rotate(-15deg);
        }
        
        .profile-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        
        .profile-sidebar {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 25px;
            height: fit-content;
        }
        
        .profile-main {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 25px;
        }
        
        .user-card {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .user-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0 auto 15px;
            position: relative;
            overflow: hidden;
        }
        
        .user-avatar-large img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .edit-avatar-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .edit-avatar-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        
        .user-card h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .user-card p {
            color: var(--gray);
            margin-bottom: 15px;
        }
        
        .user-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        
        .sidebar-section h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: var(--primary);
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .info-item i {
            color: var(--primary);
            width: 20px;
        }
        
        .info-item span {
            color: var(--gray);
        }
        
        .badges-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .badge-item {
            text-align: center;
        }
        
        .badge-icon {
            width: 40px;
            height: 40px;
            background: rgba(46, 125, 50, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--primary);
            margin: 0 auto 5px;
            position: relative;
        }
        
        .badge-icon[data-tooltip] {
            cursor: help;
        }
        
        .badge-icon[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            background: var(--dark);
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 100;
        }
        
        .badge-name {
            font-size: 0.7rem;
            color: var(--gray);
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
            color: var(--primary-dark);
        }
        
        .profile-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-group {
            margin-bottom: 15px;
        }
        
        .detail-group h3 {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .detail-group p {
            font-size: 1.1rem;
        }
        
        .activity-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: var(--gray);
            position: relative;
            transition: var(--transition);
        }
        
        .tab-btn.active {
            color: var(--primary);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .activity-list {
            list-style: none;
        }
        
        .activity-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            background: rgba(46, 125, 50, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-content p {
            margin-bottom: 5px;
        }
        
        .activity-time {
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        .question-item, .answer-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .question-title, .answer-question {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-dark);
        }
        
        .question-meta, .answer-meta {
            display: flex;
            gap: 15px;
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .footer {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-top: 50px;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: white;
            text-decoration: none;
            transition: var(--transition);
        }
        
        .footer-links a:hover {
            color: var(--accent);
        }
        
        .notification-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .notification-toast.show {
            opacity: 1;
        }
        
        .notification-toast.success {
            background: var(--primary);
        }
        
        .notification-toast.error {
            background: #d32f2f;
        }
        
        .notification-toast.info {
            background: #1976d2;
        }
        
        /* نموذج تعديل الملف الشخصي */
        .edit-profile-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .avatar-upload {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
        }
        
        .avatar-preview {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-light);
        }
        
        .avatar-upload-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .avatar-upload-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        
        .avatar-upload input[type="file"] {
            display: none;
        }
        
        /* حذف الحساب */
        .delete-account-section {
            margin-top: 40px;
            padding: 20px;
            border: 1px solid #f44336;
            border-radius: 8px;
            background: rgba(244, 67, 54, 0.05);
        }
        
        .delete-account-section h3 {
            color: #f44336;
            margin-bottom: 10px;
        }
        
        .delete-account-section p {
            margin-bottom: 15px;
            color: var(--gray);
        }
        
        /* تأكيد حذف الحساب */
        .confirm-delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .confirm-delete-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .confirm-delete-content h3 {
            margin-bottom: 15px;
            color: #f44336;
        }
        
        .confirm-delete-content p {
            margin-bottom: 20px;
            color: var(--gray);
        }
        
        .confirm-delete-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        @media (max-width: 992px) {
            .profile-content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .user-stats {
                flex-wrap: wrap;
            }
            
            .badges-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .profile-details {
                grid-template-columns: 1fr;
            }
            
            .edit-profile-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- شريط التنقل -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <i class="fas fa-seedling"></i>
                <span>EcoPlant DZ</span>
            </a>
            
            <div class="nav-links">
                <a href="index.html">الرئيسية</a>
                <a href="dashboard.html">لوحة التحكم</a>
                <a href="questions.html">الأسئلة</a>
                <a href="messages.html">الرسائل</a>
                <a href="about.html">من نحن</a>
                <a href="contact.html">التواصل و الدعم</a>
            </div>
            
            <div class="nav-actions">
                <div class="notification-icon" onclick="openModal('notificationsModal')">
                    <i class="fas fa-bell"></i>
                    <span class="badge" id="notificationCount">0</span>
                </div>
                
                <div class="messages-icon" onclick="window.location.href='messages.html'">
                    <i class="fas fa-envelope"></i>
                    <span class="badge" id="messageCount">0</span>
                </div>
                
                <div class="user-menu">
                    <button class="user-btn">
                        <div class="user-avatar" id="navAvatar">م</div>
                        <span id="navUserName">مستخدم</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    
                    <div class="dropdown-menu" id="userDropdown">
                        <a href="dashboard.html" class="dropdown-item">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>لوحة التحكم</span>
                        </a>
                        <a href="profile.html" class="dropdown-item">
                            <i class="fas fa-user"></i>
                            <span>الملف الشخصي</span>
                        </a>
                        <a href="settings.html" class="dropdown-item">
                            <i class="fas fa-cog"></i>
                            <span>الإعدادات</span>
                        </a>
                        <a href="#" class="dropdown-item" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>تسجيل الخروج</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- محتوى الملف الشخصي -->
    <div class="profile-container">
        <!-- رأس الصفحة -->
        <div class="profile-header">
            <i class="fas fa-user banner-icon"></i>
            <h1 id="profileTitle">الملف الشخصي</h1>
            <p id="profileSubtitle">هنا يمكنك عرض وتعديل معلوماتك الشخصية ومتابعة نشاطك في المجتمع</p>
        </div>
        
        <!-- محتوى الملف الشخصي -->
        <div class="profile-content">
            <!-- الشريط الجانبي -->
            <div class="profile-sidebar">
                <div class="user-card">
                    <div class="user-avatar-large" id="profileAvatarLarge">م</div>
                    <h2 id="profileName">مستخدم EcoPlant</h2>
                    <p id="profileRole">عضو في مجتمع EcoPlant DZ</p>
                    
                    <div class="user-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="questionsCount">0</div>
                            <div class="stat-label">أسئلة</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="answersCount">0</div>
                            <div class="stat-label">إجابات</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ecoPointsCount">0</div>
                            <div class="stat-label">نقاط Eco</div>
                        </div>
                    </div>
                    
                    <a href="#" class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="toggleEditMode()">
                        <i class="fas fa-edit"></i> تعديل الملف الشخصي
                    </a>
                </div>
                
                <div class="sidebar-section">
                    <h3>معلومات التواصل</h3>
                    <div class="info-item">
                        <i class="fas fa-envelope"></i>
                        <span id="profileEmail">سيتم عرضه بعد تسجيل الدخول</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="profileStateSidebar">غير محدد</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-university"></i>
                        <span id="profileUniversitySidebar">غير محدد</span>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h3>شاراتي</h3>
                    <div class="badges-grid" id="profileBadges">
                        <div class="badge-item">
                            <div class="badge-icon" data-tooltip="مستكشف مبكر">
                                <i class="fas fa-seedling"></i>
                            </div>
                            <div class="badge-name">مستكشف</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- المحتوى الرئيسي -->
            <div class="profile-main">
                <h2 class="section-title">معلومات الملف الشخصي</h2>
                
                <!-- عرض المعلومات -->
                <div id="viewMode">
                    <div class="profile-details">
                        <div class="detail-group">
                            <h3>الاسم الكامل</h3>
                            <p id="profileFullName">مستخدم EcoPlant</p>
                        </div>
                        
                        <div class="detail-group">
                            <h3>الدور</h3>
                            <p id="profileRoleMain">عضو في مجتمع EcoPlant DZ</p>
                        </div>
                        
                        <div class="detail-group">
                            <h3>الولاية</h3>
                            <p id="profileStateMain">غير محدد</p>
                        </div>
                        
                        <div class="detail-group">
                            <h3>الجامعة/المؤسسة</h3>
                            <p id="profileUniversityMain">غير محدد</p>
                        </div>
                        
                        <div class="detail-group">
                            <h3>التخصص</h3>
                            <p id="profileSpecializationMain">غير محدد</p>
                        </div>
                        
                        <div class="detail-group">
                            <h3>تاريخ الانضمام</h3>
                            <p id="profileJoinDate">اليوم</p>
                        </div>
                    </div>
                    
                    <div class="detail-group">
                        <h3>السيرة الذاتية</h3>
                        <p id="profileBio">لم يتم إضافة سيرة ذاتية بعد.</p>
                    </div>
                </div>
                
                <!-- نموذج التعديل -->
                <div id="editMode" style="display: none;">
                    <div class="avatar-upload">
                        <img id="avatarPreview" src="https://via.placeholder.com/120" alt="صورة الملف الشخصي" class="avatar-preview">
                        <label for="avatarInput" class="avatar-upload-btn">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="avatarInput" accept="image/*">
                    </div>
                    
                    <div class="edit-profile-form">
                        <div class="form-group">
                            <label for="editFirstName">الاسم الأول</label>
                            <input type="text" id="editFirstName" placeholder="أدخل اسمك الأول">
                        </div>
                        
                        <div class="form-group">
                            <label for="editLastName">الاسم الأخير</label>
                            <input type="text" id="editLastName" placeholder="أدخل اسمك الأخير">
                        </div>
                        
                        <div class="form-group">
                            <label for="editEmail">البريد الإلكتروني</label>
                            <input type="email" id="editEmail" placeholder="أدخل بريدك الإلكتروني">
                        </div>
                        
                        <div class="form-group">
                            <label for="editState">الولاية</label>
                            <input type="text" id="editState" placeholder="أدخل ولايتك">
                        </div>
                        
                        <div class="form-group">
                            <label for="editUniversity">الجامعة/المؤسسة</label>
                            <input type="text" id="editUniversity" placeholder="أدخل جامعتك أو مؤسستك">
                        </div>
                        
                        <div class="form-group">
                            <label for="editSpecialization">التخصص</label>
                            <input type="text" id="editSpecialization" placeholder="أدخل تخصصك">
                        </div>
                        
                        <div class="form-group">
                            <label for="editBio">السيرة الذاتية</label>
                            <textarea id="editBio" placeholder="أدخل سيرتك الذاتية"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="saveProfile()">
                            <i class="fas fa-save"></i> حفظ التغييرات
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </div>
                </div>
                
                <h2 class="section-title" style="margin-top: 30px;">النشاط الأخير</h2>
                
                <div class="activity-tabs">
                    <button class="tab-btn active" data-tab="activities">النشاط العام</button>
                    <button class="tab-btn" data-tab="questions">أسئلتي</button>
                    <button class="tab-btn" data-tab="answers">إجاباتي</button>
                </div>
                
                <div class="tab-content active" id="activities-tab">
                    <ul class="activity-list" id="activityList">
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="activity-content">
                                <p>انضممت إلى مجتمع EcoPlant DZ</p>
                                <span class="activity-time" id="joinDate">الآن</span>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <div class="tab-content" id="questions-tab">
                    <div id="userQuestionsList">
                        <p style="text-align: center; padding: 20px; color: var(--gray);">لم تقم بطرح أي أسئلة بعد.</p>
                    </div>
                </div>
                
                <div class="tab-content" id="answers-tab">
                    <div id="userAnswersList">
                        <p style="text-align: center; padding: 20px; color: var(--gray);">لم تقم بالإجابة على أي أسئلة بعد.</p>
                    </div>
                </div>
                
                <!-- قسم حذف الحساب -->
                <div class="delete-account-section">
                    <h3>حذف الحساب</h3>
                    <p>سيؤدي حذف حسابك إلى إزالة جميع بياناتك بشكل نهائي. لا يمكن التراجع عن هذا الإجراء.</p>
                    <button type="button" class="btn btn-danger" onclick="showDeleteConfirmation()">
                        <i class="fas fa-trash"></i> حذف حسابي
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نافذة تأكيد حذف الحساب -->
    <div class="confirm-delete-modal" id="deleteConfirmationModal">
        <div class="confirm-delete-content">
            <h3>تأكيد حذف الحساب</h3>
            <p>هل أنت متأكد من رغبتك في حذف حسابك؟ هذا الإجراء لا يمكن التراجع عنه وسيتم حذف جميع بياناتك.</p>
            <div class="confirm-delete-actions">
                <button type="button" class="btn btn-danger" onclick="deleteAccount()">
                    <i class="fas fa-trash"></i> نعم، احذف حسابي
                </button>
                <button type="button" class="btn btn-secondary" onclick="hideDeleteConfirmation()">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- التذييل -->
    <footer class="footer">
        <div class="footer-content">
            <p>© 2025 EcoPlant DZ. جميع الحقوق محفوظة</p>
            <div class="footer-links">
                <a href="#" onclick="openModal('privacyModal')">سياسة الخصوصية</a>
                <a href="#" onclick="openModal('termsModal')">شروط الاستخدام</a>
            </div>
        </div>
    </footer>
    
    <!-- مكتبات Firebase v10 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, onIdTokenChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getDatabase, ref, set, get, child, update, onValue, remove, query, orderByChild, equalTo, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
        import { uploadToCloudinary } from "./js/cloudinary.js";
        
        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCVELN-Jca7q3xtS0uWk2ZrNnlqXJzsKpg",
            authDomain: "ecoplant-dz-148bf.firebaseapp.com",
            databaseURL: "https://ecoplant-dz-148bf-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ecoplant-dz-148bf",
            storageBucket: "ecoplant-dz-148bf.appspot.com",
            messagingSenderId: "233372376001",
            appId: "1:233372376001:web:2c261f4bf161a65f726d40",
            measurementId: "G-4PJZMLMKJE"
        };
        
        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);
        
        // متغيرات عامة
        let currentUser = null;
        let isEditMode = false;
        
        // مراقبة حالة المستخدم
        document.addEventListener("DOMContentLoaded", () => {
            // مراقب تسجيل الدخول والخروج
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    localStorage.clear();
                    window.location.href = "login.html";
                    return;
                }
                
                try {
                    currentUser = user;
                    
                    // جلب بيانات المستخدم ومراقبتها بشكل مباشر
                    const userRef = ref(db, "users/" + user.uid);
                    onValue(userRef, (snapshot) => {
                        const userData = snapshot.val() || {};
                        
                        // حفظ البيانات محليًا
                        localStorage.setItem("user", JSON.stringify(userData));
                        
                        // تحديث واجهة المستخدم
                        updateUserInterface(userData, user);
                    });
                    
                    // تحميل الإحصائيات
                    loadUserStats(user.uid);
                    
                    // تحميل النشاط الأخير
                    loadRecentActivity(user.uid);
                    
                    // تحميل الأسئلة
                    loadUserQuestions(user.uid);
                    
                    // تحميل الإجابات
                    loadUserAnswers(user.uid);
                    
                } catch (err) {
                    console.error("فشل تحميل بيانات المستخدم:", err);
                    showNotification("فشل في تحميل بيانات المستخدم", "error");
                }
            });
            
            // مراقب لتجديد التوكن والخروج التلقائي إذا كان الحساب محذوفاً
            onIdTokenChanged(auth, async (user) => {
                if (!user) return;
                try {
                    await user.getIdToken(true);
                } catch (e) {
                    console.warn("Auth token invalid — signing out:", e);
                    try { 
                        await signOut(auth); 
                    } catch {}
                    localStorage.clear();
                    window.location.href = "login.html";
                }
            });
            
            // إدارة القائمة المنسدلة
            document.querySelector('.user-btn').addEventListener('click', function() {
                document.getElementById('userDropdown').classList.toggle('show');
            });
            
            // إغلاق القائمة المنسدلة عند النقر خارجها
            window.addEventListener('click', function(event) {
                if (!event.target.matches('.user-btn') && !event.target.closest('.user-btn')) {
                    const dropdown = document.getElementById('userDropdown');
                    if (dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                    }
                }
            });
            
            // تسجيل الخروج
            document.getElementById("logoutBtn").addEventListener("click", async () => {
                try {
                    await signOut(auth);
                    localStorage.clear();
                    window.location.href = "login.html";
                } catch (error) {
                    console.error("فشل تسجيل الخروج:", error);
                    showNotification("فشل في تسجيل الخروج", "error");
                }
            });
            
            // إعداد تبويبات النشاط
            setupActivityTabs();
            
            // إعداد رفع الصورة
            setupImageUpload();
        });
        
        // تحديث واجهة المستخدم
        function updateUserInterface(userData, user) {
            const fullName = `${userData.firstName || ""} ${userData.lastName || ""}`.trim() || "مستخدم EcoPlant";
            
            // تحديث البيانات النصية
            safeSetText("navUserName", fullName);
            safeSetText("profileTitle", `الملف الشخصي - ${userData.firstName || "مستخدم"}`);
            safeSetText("profileName", fullName);
            safeSetText("profileFullName", fullName);
            safeSetText("profileRole", userData.role || "عضو في مجتمع EcoPlant DZ");
            safeSetText("profileRoleMain", userData.role || "عضو في مجتمع EcoPlant DZ");
            safeSetText("profileStateSidebar", userData.state || "غير محدد");
            safeSetText("profileStateMain", userData.state || "غير محدد");
            safeSetText("profileUniversitySidebar", userData.university || "غير محدد");
            safeSetText("profileUniversityMain", userData.university || "غير محدد");
            safeSetText("profileSpecializationMain", userData.specialization || "غير محدد");
            safeSetText("profileEmail", user.email || "غير محدد");
            
            if (userData.bio) {
                safeSetText("profileBio", userData.bio);
            } else {
                safeSetText("profileBio", "لم يتم إضافة سيرة ذاتية بعد.");
            }
            
            const joinDate = userData.createdAt ? new Date(userData.createdAt) : new Date();
            safeSetText("profileJoinDate", joinDate.toLocaleDateString('ar-AR'));
            safeSetText("joinDate", formatTime(userData.createdAt || Date.now()));
            
            // تحديث الصورة الرمزية
            const avatarUrl = user.photoURL || userData.photoURL;
            if (avatarUrl) {
                safeSetHTML("profileAvatarLarge", `<img src="${avatarUrl}" alt="${fullName}">`);
                safeSetHTML("navAvatar", `<img src="${avatarUrl}" alt="${fullName}">`);
            } else {
                const letter = (userData.firstName?.[0] || user.displayName?.[0] || "م").toUpperCase();
                safeSetText("profileAvatarLarge", letter);
                safeSetText("navAvatar", letter);
            }
            
            // تحديث الشارات
            updateBadges(userData.badges || []);
        }
        
        // تحديث الشارات
        function updateBadges(badges) {
            const badgesContainer = document.getElementById("profileBadges");
            
            if (!badges || badges.length === 0) {
                badgesContainer.innerHTML = `
                    <div class="badge-item">
                        <div class="badge-icon" data-tooltip="مستكشف مبكر">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="badge-name">مستكشف</div>
                    </div>
                `;
                return;
            }
            
            let badgesHTML = "";
            badges.forEach(badge => {
                badgesHTML += `
                    <div class="badge-item">
                        <div class="badge-icon" data-tooltip="${badge.name}">
                            <i class="${badge.icon}"></i>
                        </div>
                        <div class="badge-name">${badge.name}</div>
                    </div>
                `;
            });
            
            badgesContainer.innerHTML = badgesHTML;
        }
        
        // تحميل إحصائيات المستخدم
        async function loadUserStats(userId) {
            try {
                // تحميل عدد الأسئلة
                const questionsQuery = query(
                    ref(db, "questions"),
                    orderByChild("userId"),
                    equalTo(userId)
                );
                const questionsSnapshot = await get(questionsQuery);
                const questionsCount = questionsSnapshot.exists() ? questionsSnapshot.size : 0;
                safeSetText("questionsCount", questionsCount);
                
                // تحميل عدد الإجابات
                const answersQuery = query(
                    ref(db, "answers"),
                    orderByChild("userId"),
                    equalTo(userId)
                );
                const answersSnapshot = await get(answersQuery);
                const answersCount = answersSnapshot.exists() ? answersSnapshot.size : 0;
                safeSetText("answersCount", answersCount);
                
                // تحميل عدد الرسائل غير المقروءة
                const messagesQuery = query(
                    ref(db, "messages"),
                    orderByChild("receiverId"),
                    equalTo(userId)
                );
                const messagesSnapshot = await get(messagesQuery);
                let unreadCount = 0;
                if (messagesSnapshot.exists()) {
                    messagesSnapshot.forEach(childSnapshot => {
                        if (!childSnapshot.val().read) {
                            unreadCount++;
                        }
                    });
                }
                
                const messageBadge = document.getElementById("messageCount");
                if (messageBadge) {
                    messageBadge.textContent = unreadCount > 0 ? unreadCount : "";
                    messageBadge.style.display = unreadCount > 0 ? "flex" : "none";
                }
                
                // تحميل نقاط Eco
                const userSnapshot = await get(child(ref(db), "users/" + userId));
                const userData = userSnapshot.val() || {};
                safeSetText("ecoPointsCount", userData.ecoPoints || 0);
                
            } catch (error) {
                console.error("فشل تحميل الإحصائيات:", error);
            }
        }
        
        // تحميل النشاط الأخير
        async function loadRecentActivity(userId) {
            try {
                const activityList = document.getElementById("activityList");
                
                // الحصول على نشاط الأسئلة الأخيرة
                const questionsQuery = query(
                    ref(db, "questions"),
                    orderByChild("userId"),
                    equalTo(userId),
                    limitToLast(5)
                );
                const questionsSnapshot = await get(questionsQuery);
                
                // الحصول على نشاط الإجابات الأخيرة
                const answersQuery = query(
                    ref(db, "answers"),
                    orderByChild("userId"),
                    equalTo(userId),
                    limitToLast(5)
                );
                const answersSnapshot = await get(answersQuery);
                
                let activities = [];
                
                // إضافة الأسئلة
                if (questionsSnapshot.exists()) {
                    questionsSnapshot.forEach(childSnapshot => {
                        const question = childSnapshot.val();
                        activities.push({
                            type: 'question',
                            title: `طرح سؤال جديد: ${question.title}`,
                            timestamp: question.createdAt,
                            icon: 'fa-question-circle'
                        });
                    });
                }
                
                // إضافة الإجابات
                if (answersSnapshot.exists()) {
                    answersSnapshot.forEach(childSnapshot => {
                        const answer = childSnapshot.val();
                        activities.push({
                            type: 'answer',
                            title: `أضاف إجابة جديدة`,
                            timestamp: answer.createdAt,
                            icon: 'fa-comments'
                        });
                    });
                }
                
                // إضافة نشاط الانضمام
                const userSnapshot = await get(child(ref(db), "users/" + userId));
                const userData = userSnapshot.val() || {};
                activities.push({
                    type: 'join',
                    title: 'انضم إلى مجتمع EcoPlant DZ',
                    timestamp: userData.createdAt || Date.now(),
                    icon: 'fa-user-plus'
                });
                
                // ترتيب النشاط حسب التاريخ
                activities.sort((a, b) => b.timestamp - a.timestamp);
                
                // عرض آخر 5 أنشطة
                activities = activities.slice(0, 5);
                
                // تحديث واجهة المستخدم
                let html = '';
                activities.forEach(activity => {
                    html += `
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="fas ${activity.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <p>${activity.title}</p>
                                <span class="activity-time">${formatTime(activity.timestamp)}</span>
                            </div>
                        </li>
                    `;
                });
                
                activityList.innerHTML = html;
            } catch (error) {
                console.error("فشل تحميل النشاط الأخير:", error);
                document.getElementById("activityList").innerHTML = `
                    <li class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="activity-content">
                            <p>انضممت إلى مجتمع EcoPlant DZ</p>
                            <span class="activity-time">الآن</span>
                        </div>
                    </li>
                `;
            }
        }
        
        // تحميل أسئلة المستخدم
        async function loadUserQuestions(userId) {
            try {
                const questionsList = document.getElementById("userQuestionsList");
                
                const questionsQuery = query(
                    ref(db, "questions"),
                    orderByChild("userId"),
                    equalTo(userId)
                );
                const questionsSnapshot = await get(questionsQuery);
                
                if (!questionsSnapshot.exists()) {
                    questionsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray);">لم تقم بطرح أي أسئلة بعد.</p>';
                    return;
                }
                
                let html = '';
                questionsSnapshot.forEach(childSnapshot => {
                    const question = childSnapshot.val();
                    html += `
                        <div class="question-item">
                            <div class="question-title">${question.title}</div>
                            <div class="question-content">${question.content}</div>
                            <div class="question-meta">
                                <span>${formatTime(question.createdAt)}</span>
                                <span>${question.answersCount || 0} إجابة</span>
                                <span>${question.viewsCount || 0} مشاهدة</span>
                            </div>
                        </div>
                    `;
                });
                
                questionsList.innerHTML = html;
            } catch (error) {
                console.error("فشل تحميل أسئلة المستخدم:", error);
                document.getElementById("userQuestionsList").innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray);">حدث خطأ أثناء تحميل الأسئلة.</p>';
            }
        }
        
        // تحميل إجابات المستخدم
        async function loadUserAnswers(userId) {
            try {
                const answersList = document.getElementById("userAnswersList");
                
                const answersQuery = query(
                    ref(db, "answers"),
                    orderByChild("userId"),
                    equalTo(userId)
                );
                const answersSnapshot = await get(answersQuery);
                
                if (!answersSnapshot.exists()) {
                    answersList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray);">لم تقم بالإجابة على أي أسئلة بعد.</p>';
                    return;
                }
                
                let html = '';
                answersSnapshot.forEach(async (childSnapshot) => {
                    const answer = childSnapshot.val();
                    
                    // الحصول على بيانات السؤال
                    try {
                        const questionSnapshot = await get(child(ref(db), "questions/" + answer.questionId));
                        const question = questionSnapshot.val() || {};
                        
                        html += `
                            <div class="answer-item">
                                <div class="answer-question">على سؤال: ${question.title || "حذف السؤال"}</div>
                                <div class="answer-content">${answer.content}</div>
                                <div class="answer-meta">
                                    <span>${formatTime(answer.createdAt)}</span>
                                    <span>${answer.likesCount || 0} إعجاب</span>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.error("فشل الحصول على بيانات السؤال:", error);
                    }
                });
                
                answersList.innerHTML = html;
            } catch (error) {
                console.error("فشل تحميل إجابات المستخدم:", error);
                document.getElementById("userAnswersList").innerHTML = '<p style="text-align: center; padding: 20px; color: var(--gray);">حدث خطأ أثناء تحميل الإجابات.</p>';
            }
        }
        
        // إعداد تبويبات النشاط
        function setupActivityTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // إزالة النشاط من جميع الأزرار
                    tabBtns.forEach(b => b.classList.remove('active'));
                    // إخفاء جميع المحتويات
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // إضافة النشاط للزر المحدد
                    btn.classList.add('active');
                    // عرض المحتوى المرتبط
                    const tabId = btn.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }
        
        // إعداد رفع الصورة
        function setupImageUpload() {
            const avatarInput = document.getElementById('avatarInput');
            const avatarPreview = document.getElementById('avatarPreview');
            
            if (avatarInput) {
                avatarInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            avatarPreview.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }
        
        // تبديل وضع التعديل
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const viewMode = document.getElementById('viewMode');
            const editMode = document.getElementById('editMode');
            
            if (isEditMode) {
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
                
                // ملء النموذج بالبيانات الحالية
                const userSnapshot = get(child(ref(db), "users/" + currentUser.uid));
                userSnapshot.then((snapshot) => {
                    const userData = snapshot.val() || {};
                    
                    document.getElementById('editFirstName').value = userData.firstName || '';
                    document.getElementById('editLastName').value = userData.lastName || '';
                    document.getElementById('editEmail').value = currentUser.email || '';
                    document.getElementById('editState').value = userData.state || '';
                    document.getElementById('editUniversity').value = userData.university || '';
                    document.getElementById('editSpecialization').value = userData.specialization || '';
                    document.getElementById('editBio').value = userData.bio || '';
                    
                    // تحديث الصورة
                    const avatarUrl = currentUser.photoURL || userData.photoURL;
                    if (avatarUrl) {
                        document.getElementById('avatarPreview').src = avatarUrl;
                    }
                });
            } else {
                viewMode.style.display = 'block';
                editMode.style.display = 'none';
            }
        }
        
        // حفظ الملف الشخصي
        async function saveProfile() {
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            try {
                showNotification('جاري حفظ التغييرات...', 'info');
                
                const updates = {
                    firstName: document.getElementById('editFirstName').value,
                    lastName: document.getElementById('editLastName').value,
                    state: document.getElementById('editState').value,
                    university: document.getElementById('editUniversity').value,
                    specialization: document.getElementById('editSpecialization').value,
                    bio: document.getElementById('editBio').value,
                    updatedAt: Date.now()
                };
                
                // رفع الصورة الجديدة إذا تم اختيارها
                const avatarInput = document.getElementById('avatarInput');
                if (avatarInput.files[0]) {
                    const file = avatarInput.files[0];
                    
                    // التحقق من حجم الملف (5MB كحد أقصى)
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('حجم الصورة يجب أن يكون أقل من 5MB', 'error');
                        return;
                    }
                    
                    // رفع الصورة إلى Cloudinary
                    const uploadResult = await uploadToCloudinary(file);
                    const photoURL = uploadResult.secure_url;
                    
                    // تحديث صورة الملف الشخصي في Firebase Authentication
                    await updateProfile(currentUser, { photoURL });
                    
                    // إضافة رابط الصورة إلى التحديثات
                    updates.photoURL = photoURL;
                }
                
                // تحديث البيانات في قاعدة البيانات
                await update(ref(db, "users/" + currentUser.uid), updates);
                
                // العودة إلى وضع العرض
                toggleEditMode();
                
                showNotification('تم حفظ التغييرات بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في حفظ الملف الشخصي:', error);
                showNotification('فشل حفظ التغييرات: ' + error.message, 'error');
            }
        }
        
        // إلغاء التعديل
        function cancelEdit() {
            toggleEditMode();
        }
        
        // عرض نافذة تأكيد الحذف
        function showDeleteConfirmation() {
            document.getElementById('deleteConfirmationModal').style.display = 'flex';
        }
        
        // إخفاء نافذة تأكيد الحذف
        function hideDeleteConfirmation() {
            document.getElementById('deleteConfirmationModal').style.display = 'none';
        }
        
        // حذف الحساب
        async function deleteAccount() {
            if (!currentUser) {
                showNotification('يجب تسجيل الدخول أولاً', 'error');
                return;
            }
            
            try {
                showNotification('جاري حذف الحساب...', 'info');
                
                // حذف صورة الملف الشخصي من التخزين إذا كانت موجودة
                const userSnapshot = await get(child(ref(db), "users/" + currentUser.uid));
                const userData = userSnapshot.val() || {};
                
                if (userData.photoURL && userData.photoURL.includes('cloudinary')) {
                    try {
                        // استخراج معرف الصورة من الرابط
                        const publicId = userData.photoURL.split('/').pop().split('.')[0];
                        await fetch(`https://api.cloudinary.com/v1_1/dq5cgwwjt/image/destroy`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                public_id: publicId,
                                api_key: 'YOUR_API_KEY',
                                api_secret: 'YOUR_API_SECRET'
                            })
                        });
                    } catch (error) {
                        console.error('فشل حذف الصورة من Cloudinary:', error);
                    }
                }
                
                // حذف بيانات المستخدم من قاعدة البيانات
                await remove(ref(db, "users/" + currentUser.uid));
                
                // حذف أسئلة المستخدم
                const questionsQuery = query(
                    ref(db, "questions"),
                    orderByChild("userId"),
                    equalTo(currentUser.uid)
                );
                const questionsSnapshot = await get(questionsQuery);
                if (questionsSnapshot.exists()) {
                    questionsSnapshot.forEach(async (childSnapshot) => {
                        await remove(ref(db, "questions/" + childSnapshot.key));
                    });
                }
                
                // حذف إجابات المستخدم
                const answersQuery = query(
                    ref(db, "answers"),
                    orderByChild("userId"),
                    equalTo(currentUser.uid)
                );
                const answersSnapshot = await get(answersQuery);
                if (answersSnapshot.exists()) {
                    answersSnapshot.forEach(async (childSnapshot) => {
                        await remove(ref(db, "answers/" + childSnapshot.key));
                    });
                }
                
                // حذف رسائل المستخدم
                const messagesQuery = query(
                    ref(db, "messages"),
                    orderByChild("senderId"),
                    equalTo(currentUser.uid)
                );
                const messagesSnapshot = await get(messagesQuery);
                if (messagesSnapshot.exists()) {
                    messagesSnapshot.forEach(async (childSnapshot) => {
                        await remove(ref(db, "messages/" + childSnapshot.key));
                    });
                }
                
                // حذف حساب المستخدم من Firebase Authentication
                await currentUser.delete();
                
                // إخفاء نافذة التأكيد
                hideDeleteConfirmation();
                
                // توجيه المستخدم إلى صفحة تسجيل الدخول
                showNotification('تم حذف حسابك بنجاح', 'success');
                
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                
            } catch (error) {
                console.error('خطأ في حذف الحساب:', error);
                showNotification('فشل حذف الحساب: ' + error.message, 'error');
            }
        }
        
        // أدوات مساعدة
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }
        
        function safeSetHTML(id, html) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = html;
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return 'الآن';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'الآن';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} دقيقة`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} ساعة`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)} يوم`;
            
            return date.toLocaleDateString('ar-AR');
        }
        
        // عرض إشعارات النظام
        function showNotification(message, type = "info") {
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // إظهار الإشعار
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // إخفاء الإشعار بعد 3 ثوان
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>